<!DOCTYPE html>
<html>
	<head>
		<title>NoteBase</title>
		<link href="https://fonts.googleapis.com/css?family=Lobster&display=swap" rel="stylesheet">
		<script src="https://kit.fontawesome.com/7aeeb0532f.js"></script>
		<link rel="stylesheet" type="text/css" href="index.css">
	</head>
	<body>
		<script type="text/javascript">
			
		</script>
		<div id="main">
			<div id="topics"></div>

			<div id="topics-input">
				<textarea id="info" placeholder="Type note here" onkeyup="javascript:errormsg.innerHTML = ''"></textarea>
				<div id="user-options">
					<div id="user-options-save" onclick="saveInfo()">Save</div>
					<div id="user-options-delete" style="display: none;" onclick="deleteInfo()">Delete</div>
				</div>
			</div>

			<div id="errormsg"></div>

			<div id="license-header">2019 @ Geottuse, Inc</div>

			<div id="hidden-box" style="display: none;">
				<div id="add-box">
					<h3 id="add-header">Enter a topic for your note:</h3>

					<input id="add-input">

					<div id="add-options">
						<div id="add-button" onclick="showAddBox(false, 0)">Cancel</div>
						<div id="add-button" onclick="addTopic()">Done</div>
					</div>
				</div>

				<div id="confirm-save-box" style="display: none">
					<div id="confirm-header">Note Saved</div>
				</div>

				<div id="confirm-delete-box" style="display: none">
					<div id="confirm-header">Note Deleted</div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
			// all topics
			var all_topics_url = 'http://localhost:8000/get_all_topics'

			// elements
			var errormsg = document.getElementById("errormsg")
			var topics_box = document.getElementById("topics")
			var topics_input = document.getElementById("topics-input")
			var info = document.getElementById("info")
			var save_button = document.getElementById("user-options-save")
			var delete_button = document.getElementById("user-options-delete")

			// hidden box
			// add
			var topic_index = 0
			var hidden_box = document.getElementById("hidden-box")
			var add_box = document.getElementById("add-box")
			var save_confirm_box = document.getElementById("confirm-save-box")
			var delete_confirm_box = document.getElementById("confirm-delete-box")
			var new_topic = document.getElementById("add-input")

			var selected_topics = [''], topics = [{ topic: "",show: false }], blank
			var all_topics = []

			function displayTopics() {
				var topic_type, topic_box = ""

				topics.forEach(function ({ topic, show }, index){
					topic_type = index > 0 ? "Sub topic #" + index : "Topic"

					topic_box += "<div class='topic'>"

					if (index == 0) {
						topic_box += "\t<div class='delete-topic-disabled'></div>"
					} else {
						topic_box += "\t<div class='delete-topic' onclick='removeTopic(" + index + ")'><i class='fas fa-times'></i></div>"
					}

					topic_box += "\t<h3 class='topic-index'>" + topic_type + ":</h3>"
					topic_box += "\t<h3 class='topic-header' onclick='toggleTopicList(" + index + ")'><div>"
					topic_box += topic ? topic : "Select " + topic_type
					topic_box += "</div> <i class='fas fa-arrows-alt-v topic-toggle'></i></h3>"
					topic_box += "</div>"

					if (all_topics.length > 0) {
						topic_box += "<div class='topic-list-holder' style='display: "
						topic_box += show ? "block;'>" : "none;'>"
						topic_box += "\t<div class='topic-list'>"

						all_topics.forEach(function (topic) {
							if (selected_topics.indexOf(topic) > -1) {
								topic_box += "\t<div class='list-topic-selected' onclick='selectTopic(\"" + topic + "\", " + index + ")'>" + topic + "</div>"
							} else {
								topic_box += "\t<div class='list-topic-unselect' onclick='selectTopic(\"" + topic + "\", " + index + ")'>" + topic + "</div>"
							}
						})

						topic_box += "\t</div>"
					} else {
						topic_box += "<div class='topic-emptylist' style='display: "
						topic_box += show ? "flex;'>" : "none;'>"
						topic_box += "\t<h3 id='no-results'>No Topic(s)</h3>"
					}

					topic_box += "\t<div id='add-topic' onclick='showAddBox(true, " + index + ")'>Add A Topic</div>"
					topic_box += "</div>"
					topic_box += "<div class='push-topic' onclick='pushOption(" + index + ")'>Add Subtopic</div>"
				})

				topics_box.innerHTML = topic_box
				topics_input.style.display = topics.length > 0 ? "block" : "none"
				errormsg.innerHTML = ""
			}

			async function getAllTopics() {
				var response = await fetch('http://localhost:8000/get_all_topics')
				var json = await response.json()

				all_topics = json
			}

			/* topic controls */
			function showAddBox(toggle, index) {
				hidden_box.style.display = toggle ? "flex" : "none"
				add_box.style.display = toggle ? "flex" : "none"

				topic_index = toggle ? index : 0
			}

			function addTopic() {
				topics[topic_index].topic = new_topic.value
				topics[topic_index].show = false
				selected_topics[topic_index] = new_topic.value
				hidden_box.style.display = "none"
				add_box.style.display = "none"

				displayTopics()
				getNote()
			}

			function removeTopic(index) {
				topics.splice(index, 1)
				selected_topics.splice(index, 1)

				displayTopics()
				getNote()
			}

			function toggleTopicList(index) {
				var topic = topics[index]

				topic.show = !topic.show

				topics[index] = topic

				displayTopics()
			}

			function pushOption(index) {
				topics.splice(index + 1, 0, { topic: "", show: false })

				displayTopics()
			}

			function getNote() {
				var params = new URLSearchParams()

				params.append('topics', JSON.stringify(selected_topics))

				fetch('http://localhost:8000/get_note', {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: params
				})
				.then((response) => response.json())
				.then((response) => {
					info.value = response ? response : ''

					while (info.value.replace("\"\"", "") != info.value) {
						info.value = info.value.replace("\"\"", "'")
					}

					delete_button.style.display = response ? "block" : "none"
				})
				.catch((error) => {

				})
			}
			/* end topic controls */

			/* topic input */
			function selectTopic(topic, index) {
				topics[index].topic = topic
				topics[index].show = false;
				selected_topics[index] = topic

				displayTopics()
				getNote()
			}
			/* end topic input */

			function saveInfo() {
				var params = new URLSearchParams(), blank = false
				var inputValue = document.getElementById("info").value
				var info = { topics: [], note: "" }

				topics.forEach(function ({ topic }, index) {
					if (!topic) {
						if (index < topics.length - 1) {
							blank = true

							errormsg.innerHTML = "Blank Detected"
						}
					}
				})

				if (!inputValue) {
					errormsg.innerHTML = "Write something"
				}

				if (!blank && inputValue) {
					errormsg.innerHTML = ""

					info.topics = JSON.stringify(selected_topics)
					info.note = inputValue

					while (info.note.replace("'", "") != info.note) {
						info.note = info.note.replace("'", "\"\"")
					}

					params.append('note', JSON.stringify(info))

					fetch('http://localhost:8000/save_info', {
						method: 'POST',
						headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: params
					})
					.then((response) => response.json())
					.then((response) => {
						if (response == 'succeed') {
							delete_button.style.display = "block"

							hidden_box.style.display = "flex"
							save_confirm_box.style.display = "flex"

							setTimeout(function () {
								hidden_box.style.display = "none"
								save_confirm_box.style.display = "none"
							}, 2000)
						}
					})
					.catch((error) => {
						alert(error.message)
					})
				}
			}

			async function deleteInfo() {
				var params = new URLSearchParams()
				var options, response, json

				params.append('topics', JSON.stringify(selected_topics))

				hidden_box.style.display = "flex"
				delete_confirm_box.style.display = "flex"
			
				options = {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: params
				}

				try {
					response = await fetch('http://localhost:8000/delete_info', options)
					json = await response.json()

					if (json == 'succeed') {
						delete_button.style.display = "none"

						setTimeout(function () {
							hidden_box.style.display = "none"
							delete_confirm_box.style.display = "none"
						}, 2000)
					}
				} catch(e) {

				}
			}

			displayTopics()
			getAllTopics()
		</script>
	</body>
</html>
